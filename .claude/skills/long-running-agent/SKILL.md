---
name: long-running-agent
description: 长时间运行 AI 代理工作流。适用于需要跨越多个上下文窗口完成复杂编程任务的场景。当用户需要：1) 构建大型 Web 应用，2) 开发需要多日完成的复杂功能，3) 需要跨会话保持进度的项目，4) 需要系统化测试和验证的项目时使用此 skill。基于 Anthropic 官方最佳实践，提供初始化代理和编码代理的标准工作流程。
---

# 长时间运行代理工作流

本 skill 实现了 Anthropic 官方的长时间运行 AI 代理最佳实践，使 Claude 能够在多个上下文窗口之间保持一致的进度。

## 核心概念

长时间运行代理面临的核心挑战：每个新会话都没有之前会话的记忆。本 skill 通过双重解决方案解决：

1. **初始化代理**：首次运行时设置环境
2. **编码代理**：每次会话做增量进度，留下清晰的 artifacts

## 使用方式

### 首次使用：初始化项目

当开始一个新项目时，执行以下步骤：

#### 1. 创建功能列表 (features.json)

生成完整的功能需求列表，所有功能初始状态为 `passes: false`。每个功能应包含：

```json
{
  "category": "functional",
  "description": "用户可以打开新聊天、输入查询、按回车并看到 AI 响应",
  "steps": [
    "导航到主界面",
    "点击'新聊天'按钮",
    "验证创建了新对话",
    "检查聊天区域显示欢迎状态",
    "验证对话出现在侧边栏"
  ],
  "passes": false
}
```

功能列表最佳实践：
- 使用 JSON 格式（模型比 Markdown 更不容易意外更改）
- 包含具体的端到端测试步骤
- 初始将所有功能标记为未完成
- 按优先级排序功能

#### 2. 创建启动脚本 (init.sh)

编写启动开发服务器的脚本，包含：

```bash
#!/bin/bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev &

# 等待服务器启动
sleep 5

echo "开发服务器已启动"
```

#### 3. 创建进度文件 (claude-progress.txt)

创建空的进度跟踪文件：

```
# Claude 代理工作进度

## 2024-XX-XX
- 项目初始化
- 创建功能列表
```

#### 4. 初始化 Git 仓库

```bash
git init
git add .
git commit -m "初始化项目结构"
```

### 每次会话：编码工作流

#### 会话开始步骤

每个新会话开始时，严格按顺序执行：

1. **确认工作目录**
   ```bash
   pwd
   ```

2. **了解当前进度**
   ```bash
   git log --oneline -20
   cat claude-progress.txt
   ```

3. **阅读功能列表**
   ```bash
   cat features.json
   ```

4. **选择一个功能**：选择最高优先级的未完成功能

5. **启动并测试服务器**
   ```bash
   # 读取并执行 init.sh
   cat init.sh
   # 然后执行启动命令
   ```

6. **验证基础功能**：在开始新功能前，确保应用正常运行
   - 对于 Web 应用：使用浏览器自动化工具测试核心功能
   - 对于 CLI 工具：运行基本命令
   - 对于 API：发送测试请求

7. **开始实现**：专注于单个功能的实现

#### 会话结束步骤

在完成工作或达到上下文限制时：

1. **提交代码**：使用描述性的提交信息
   ```bash
   git add .
   git commit -m "feat: 实现用户认证功能

   - 添加登录/注册页面
   - 实现 JWT token 管理
   - 添加用户会话持久化
   - 通过测试：features.json #5, #6"
   ```

2. **更新进度文件**
   ```bash
   echo "## $(date)
   - 完成功能：用户认证
   - 更新 features.json: #5, #6 标记为完成
   - Git commit: <commit-hash>" >> claude-progress.txt
   ```

3. **更新功能列表**：将已完成的功能标记为 `passes: true`

4. **留下清晰状态**：确保代码没有重大 bug，代码整洁且文档完善

## 测试策略

### 自动化测试

对于 Web 应用，使用浏览器自动化工具（如 Playwright MCP）：

```javascript
// 端到端测试示例
await page.goto('http://localhost:3000');
await page.click('button:has-text("新聊天")');
await page.fill('textarea', 'Hello');
await page.press('textarea', 'Enter');
await expect(page.locator('.message')).toContainText('Hello');
```

### 测试原则

- **只验证，不假设**：实际运行和测试功能，不要仅从代码推断
- **端到端验证**：像真实用户一样测试完整流程
- **截图验证**：使用浏览器工具的截图功能记录测试结果
- **失败处理**：如果测试失败，先修复再继续

## 常见陷阱和解决方案

### 问题 1：一次性尝试太多

**症状**：代理试图在单个会话中完成整个应用

**解决方案**：
- 严格限制每次会话只做一个功能
- 在 features.json 中明确列出每个功能
- 使用进度跟踪保持专注

### 问题 2：过早声明完成

**症状**：代理认为项目已完成，实际还有功能未实现

**解决方案**：
- 使用完整的 features.json 列表
- 只在实际测试通过后将功能标记为完成
- 使用强措辞："未经实际测试通过不得将功能标记为完成"

### 问题 3：留下混乱状态

**症状**：下次会话开始时代码无法运行或有 bug

**解决方案**：
- 每次提交前运行基本测试
- 保持代码整洁和文档化
- 使用 git history 回溯和恢复

### 问题 4：无法启动应用

**症状**：每个会话都要花时间弄清楚如何运行

**解决方案**：
- 创建 init.sh 脚本
- 在会话开始时首先读取并执行
- 在 README.md 中记录启动步骤

## 资源文件

本 skill 包含以下模板资源：

- **scripts/init_template.sh**：初始化脚本模板
- **references/feature_list.json**：功能列表模板
- **references/progress_template.txt**：进度文件模板
- **references/session_workflow.md**：会话工作流详细指南

## 最佳实践

1. **增量进度**：每次会话只做一件事，做好它
2. **清晰 artifacts**：为下一个会话留下清晰的状态记录
3. **测试驱动**：实现前先测试，实现后验证
4. **版本控制**：使用 git 跟踪每个变更
5. **文档同步**：保持代码和文档同步更新
