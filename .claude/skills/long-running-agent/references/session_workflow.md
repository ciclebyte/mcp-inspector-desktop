# 会话工作流详细指南

本指南提供长时间运行代理在每个会话中的详细工作流程。

## 完整会话流程

### 阶段 1：环境恢复 (5-10 分钟)

#### 步骤 1.1：确认工作目录
```bash
pwd
```
**目的**：确认当前工作目录
**输出**：显示完整路径

#### 步骤 1.2：检查 Git 历史
```bash
git log --oneline -20
```
**目的**：了解最近的工作内容
**关键信息**：
- 最近的提交
- 提交信息中的功能引用
- 代码变更趋势

#### 步骤 1.3：阅读进度文件
```bash
cat claude-progress.txt
```
**目的**：了解项目整体进度
**关键信息**：
- 已完成的功能
- 遇到的问题
- 下一步计划

#### 步骤 1.4：阅读功能列表
```bash
cat features.json
```
**目的**：查看所有功能状态
**关键信息**：
- 哪些功能已完成 (passes: true)
- 哪些功能待完成 (passes: false)
- 功能的优先级

### 阶段 2：环境验证 (5-10 分钟)

#### 步骤 2.1：阅读启动脚本
```bash
cat init.sh
```
**目的**：了解如何启动开发环境

#### 步骤 2.2：启动开发服务器
```bash
# 根据 init.sh 的内容执行相应命令
npm run dev
# 或
python main.py
# 或其他启动命令
```

#### 步骤 2.3：验证基础功能
**对于 Web 应用**：
```javascript
// 使用浏览器自动化工具
await page.goto('http://localhost:3000');
// 测试核心功能
```

**对于 CLI 工具**：
```bash
# 运行基本命令
app --help
app version
```

**对于 API**：
```bash
# 发送测试请求
curl http://localhost:8080/health
```

**如果基础功能失败**：
1. 停止，不要继续实现新功能
2. 调查并修复问题
3. 使用 git 回退到上一个工作状态（如果需要）
4. 重新验证基础功能

### 阶段 3：功能选择 (2-5 分钟)

#### 步骤 3.1：选择功能
从 features.json 中选择：
- **最高优先级**的功能
- **尚未完成**的功能 (passes: false)
- **当前可以完成**的功能（依赖已满足）

#### 步骤 3.2：理解需求
仔细阅读功能的：
- 描述 (description)
- 测试步骤 (steps)
- 任何备注 (notes)

### 阶段 4：功能实现 (主要工作时间)

#### 步骤 4.1：规划实现
在开始编码前：
1. 列出需要修改的文件
2. 列出需要创建的新文件
3. 识别潜在的依赖关系
4. 考虑可能的边界情况

#### 步骤 4.2：编写代码
按照规划实现功能：
1. 先创建测试（如果适用）
2. 实现核心功能
3. 添加错误处理
4. 更新文档

#### 步骤 4.3：自我验证
**代码级别**：
- 代码是否整洁？
- 是否有明显的 bug？
- 是否遵循项目编码规范？

**功能级别**：
- 是否满足功能描述？
- 是否通过了所有测试步骤？
- 边界情况是否处理？

**端到端测试**：
- 像真实用户一样测试
- 使用浏览器自动化工具（如适用）
- 验证完整的用户流程

### 阶段 5：提交和清理 (5-10 分钟)

#### 步骤 5.1：准备提交
```bash
# 查看变更
git status
git diff

# 添加文件
git add <specific-files>
# 或
git add .
```

#### 步骤 5.2：创建提交
使用描述性的提交信息：
```
feat: 实现用户认证功能

- 添加登录/注册页面组件
- 实现 JWT token 生成和验证
- 添加用户会话持久化
- 处理登录失败和错误状态
- 添加表单验证

测试通过：
- features.json #5 - 用户登录
- features.json #6 - 用户注册
- features.json #7 - 会话持久化

Git 提交：abc1234
```

提交信息最佳实践：
- 使用 Conventional Commits 格式
- 简洁描述做了什么
- 列出关键变更
- 引用相关的功能 ID

#### 步骤 5.3：更新功能列表
```bash
# 编辑 features.json
# 将完成的功能标记为 passes: true
```

#### 步骤 5.4：更新进度文件
```bash
cat >> claude-progress.txt << 'EOF'

### YYYY-MM-DD 会话 #N

**工作内容**：
- 实现用户认证功能

**已完成功能**：
- features.json #5 - 用户登录
- features.json #6 - 用户注册
- features.json #7 - 会话持久化

**Git 提交**：
- `abc1234` - feat: 实现用户认证功能

**遇到的问题**：
- JWT 库版本冲突，通过升级依赖解决

**下一步计划**：
- 实现用户权限管理
EOF
```

#### 步骤 5.5：清理状态
确保为下一个会话留下整洁状态：
- 代码没有明显的 bug
- 没有调试用的 console.log 或 print 语句
- 代码格式化一致
- 文档已更新

## 会话检查清单

在会话结束前，确认：

- [ ] 基础功能仍然正常工作
- [ ] 新功能已实现并通过测试
- [ ] 代码已提交到 Git
- [ ] features.json 已更新
- [ ] claude-progress.txt 已更新
- [ ] 代码整洁，没有明显的 bug
- [ ] 文档已同步更新

## 故障排除

### 问题：应用无法启动

**诊断步骤**：
1. 检查端口是否被占用
2. 检查依赖是否已安装
3. 检查环境变量是否配置
4. 查看错误日志

**解决方案**：
```bash
# 释放端口
lsof -ti:3000 | xargs kill -9

# 重新安装依赖
rm -rf node_modules
npm install

# 检查环境变量
env | grep -i app
```

### 问题：Git 无法提交

**诊断步骤**：
1. 检查 Git 状态
2. 查看是否有未解决的合并冲突
3. 检查 .gitignore 配置

**解决方案**：
```bash
# 查看状态
git status

# 解决冲突后
git add .

# 如果需要强制提交（谨慎使用）
git commit --no-verify
```

### 问题：测试失败

**诊断步骤**：
1. 确认开发服务器正在运行
2. 检查浏览器控制台错误
3. 查看服务器日志

**解决方案**：
- 先修复基础功能，再继续新功能
- 使用 git bisect 找到引入问题的提交
- 必要时回退到上一个工作状态

## 时间管理建议

| 阶段 | 建议时间 | 注意事项 |
|------|---------|---------|
| 环境恢复 | 5-10 分钟 | 不要跳过，这能为后续工作节省时间 |
| 环境验证 | 5-10 分钟 | 如果发现问题，立即修复，不要继续 |
| 功能选择 | 2-5 分钟 | 选择一个可完成的功能，避免贪多 |
| 功能实现 | 主要时间 | 专注一个功能，质量优先于速度 |
| 提交清理 | 5-10 分钟 | 留下整洁状态，为下次会话打好基础 |

## 总结

关键原则：
1. **增量进步**：每次会话只做一件事
2. **清晰 artifacts**：为下次会话留下清晰记录
3. **测试驱动**：实现前测试，实现后验证
4. **整洁状态**：提交前确保代码整洁可运行
